# brightness-sensor

Комплект из прошивки (ESP32-C3) и простого Windows-консольного приложения для автоматической регулировки яркости встроенного дисплея по датчику освещённости.

## Состав

- `firmware/` — Arduino-проект для ESP32-C3.
- `pc-app/` — .NET-приложение только для Windows: читает JSON из COM-порта и управляет яркостью через WMI.
- `docs/` — подключение, протокол и инструкции запуска.
- `appsettings.example.json` — пример конфигурации для ПК-приложения.

## Быстрый старт

1. Соберите и прошейте контроллер: см. `docs/build-and-run.md`.
2. Подключите датчик: см. `docs/wiring.md`.
3. Скопируйте `appsettings.example.json` в `pc-app/appsettings.json` и поправьте `serial.portName`.
4. Запустите ПК-приложение из `pc-app/`.

Важно: текущая версия ПК-приложения поддерживает только Windows. Для Linux/macOS потребуется отдельное приложение, которое сохраняет тот же контракт общения с устройством (тот же JSON-протокол из `docs/protocol.md`).

### Структура `pc-app/`

- `pc-app/Program.cs` — точка входа.
- `pc-app/Application/` — основной сценарий работы приложения.
- `pc-app/Configuration/` — загрузка и валидация `appsettings.json`.
- `pc-app/Protocol/` — парсер JSON-сообщений от устройства.
- `pc-app/Platform/Windows/` — Windows-специфичная работа с яркостью (WMI).

## Что ожидает конфиг

ПК-приложение ожидает файл `pc-app/appsettings.json` со следующими секциями:

- `serial`
  - `portName` — COM-порт ESP32 (например, `COM5`), обязательный.  
    Влияние: определяет, откуда читаются измерения; при ошибке в порте данные не читаются и яркость не меняется.
  - `baudRate` — скорость порта, обычно `115200`.  
    Влияние: должна совпадать с прошивкой, иначе телеметрия читается с ошибками или не читается вовсе.
- `processing`
  - `adcMin` — нижняя граница диапазона ADC.  
    Влияние: все значения ниже обрезаются до `adcMin`, что задает начало шкалы нормализации.
  - `adcMax` — верхняя граница диапазона ADC (обязательно `adcMax > adcMin`).  
    Влияние: все значения выше обрезаются до `adcMax`, что задает конец шкалы нормализации.
  - `invert` — инверсия шкалы (`true/false`).  
    Влияние: меняет направление зависимости (нужно, если логика датчика «перевернута»).
  - `emaAlpha` — коэффициент EMA в диапазоне `(0; 1]`.  
    Влияние: чем больше — тем быстрее реакция, чем меньше — тем плавнее и медленнее изменения.
  - `hysteresisPercent` — минимальный шаг изменения яркости в процентах (`0..100`).  
    Влияние: подавляет мелкие колебания (шум), не применяя слишком маленькие изменения.
  - `gamma` — опциональная гамма-коррекция после EMA (`null` отключает, обычно `1.8..2.2`).  
    Влияние: делает кривую яркости более «человеческой» — мягче в темной зоне и без резких скачков.
- `brightness`
  - `minPercent` — нижняя граница итоговой яркости (`0..100`).  
    Влияние: яркость не опускается ниже этого значения даже в темноте.
  - `maxPercent` — верхняя граница итоговой яркости (`0..100`, `min <= max`).  
    Влияние: яркость не поднимается выше этого значения даже при сильной освещенности.
- `calibration`
  - `enabled` — включает калибровку при запуске (`true/false`).  
    Влияние: стартовая яркость экрана и показания датчика считаются «идеальными».
  - `sampleCount` — количество валидных измерений для усреднения (`>= 1`).  
    Влияние: большее значение дает стабильнее базу, но калибровка занимает дольше.
  - `maxReadAttempts` — максимум попыток чтения датчика (`>= sampleCount`).  
    Влияние: ограничивает время ожидания калибровки при отсутствии данных.

Пример см. в `appsettings.example.json`.

## Формат телеметрии

Каждое измерение отправляется одной JSON-строкой, например:

`{"deviceId":"esp32c3-01","sensorId":"light0","ts":1234567,"value":1872}`

Подробности: `docs/protocol.md`.
